## 定时器模块

处理非活跃连接。利用`alarm`函数周期性地触发`SIGALRM`信号，该信号处理函数利用管道通知**主循环执行定时器链表上的定时任务**。

### 统一事件源

是指将信号事件与其他事件一样被处理。

信号处理函数**使用管道将信号传递给主循环**，信号处理函数往管道的写端写入信号值，主循环则从管道的读端读出信号值，使用**I/O复用系统调用来监听管道读端的可读事件**，这样信号事件与其他文件描述符都可以通过epoll来监测，从而实现统一处理。

### 管道写端要非阻塞原因

send是将信息发送给套接字缓冲区，若缓冲区满了，则会阻塞，这时候会进一步增加信号处理函数的执行时间，为此，将其修改为非阻塞。

### 定时器容器设计

项目中的定时器容器为带头尾结点的**升序双向链表**，具体的为**每个连接创建一个定时器**，将其添加到链表中，并按照超时时间升序排列。执行定时任务时，将到期的定时器从链表中删除。

从实现上看，主要涉及双向链表的插入，删除操作，其中添加定时器的事件复杂度是O(n),删除定时器的事件复杂度是O(1)。

### 定时任务处理函数

`SIGALRM`信号每次被触发，**主循环**中调用一次定时任务处理函数，处理链表容器中到期的定时器。具体的逻辑如下，

- 遍历定时器升序链表容器，从头结点开始依次处理每个定时器，直到遇到尚未到期的定时器
- 若当前时间小于定时器超时时间，跳出循环，即未找到到期的定时器
- 若当前时间大于定时器超时时间，即找到了到期的定时器，执行回调函数，然后将它从链表中删除，然后继续遍历



### 定时器使用方法

- 浏览器与服务器连接时，创建该连接对应的定时器，并将该定时器添加到链表上
- 处理异常事件时，执行定时事件，服务器关闭连接，从链表上移除对应定时器
- 处理定时信号时，将定时标志设置为true
- 处理读事件时，若某连接上发生读事件，**重置定时器的超时时间，**将对应定时器向后移动，否则，执行定时事件
- 处理写事件时，若服务器通过某连接给浏览器发送数据，重置定时器的超时时间，将对应定时器向后移动，否则，执行定时事件